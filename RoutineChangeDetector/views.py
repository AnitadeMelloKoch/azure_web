from rest_framework import status
from rest_framework.decorators import api_view
from rest_framework.response import Response
from .models import UserData, UserRoutine
from .serializers import UserDataSerializer, UserRoutineSerializer #, RecieveDataSerialiser

# from .locationMath import get_location_data, get_quick_location_data
# from .statistics import * 
import os
import numpy as np
from .inference.inferenceMLP import predict
from .inference.format_data import standardize_features

@api_view(['GET', 'POST'])
def user_data_list(request):
    """
    GET: List all UserData entries.

    POST: returns the posted data after processing.
    """
    if request.method == 'GET':
        user_data = UserData.objects.all()
        serializer = UserDataSerializer(user_data, many=True)
        return Response(serializer.data)

    elif request.method == 'POST':
        
        values_matrix = []

        for data in request.data:
            model = UserData()
            model.setValues(data)
            serializer = UserDataSerializer(model)
            if serializer.is_valid:
                # model.save()
                values_matrix.append(list(serializer.data.values())[3:])
            else:
                return Response(serializer.errors, status=status.HTTP_422_UNPROCESSABLE_ENTITY)

        # values_matrix = [
        #     [0.996815,0.003529,-0.002786,0.006496,0.995203,0.996825,0.998502,1.748756,6.684605,5.043970,0.000042,0.000364,0.000761,0.005429,0.429853,0.173685,0.148988,0.002331,0.004614,-0.996790,0.003269,0.003521,0.003539,0.106920,0.516842,0.255494,0.002558,0.001510,0.001832,0.002531,0.001526,0.002196,0.003230,2.236059,6.532865,5.149616,2.818909,3.757026,2.952941,4.312930,1.766920,4.193949,0.107787,0.000412,0.000448,-0.000541,0.001705,0.001987,0.001144,-0.372543,0.175125,-0.033004,618.751929,0.784768,-0.313058,1.038986,618.243941,618.796487,619.260475,2.594321,6.684611,5.043589,0.000015,0.000103,0.000070,0.000684,0.429649,2.430594,0.131063,223.246192,97.503453,-568.776302,1.009838,0.827983,0.769873,-0.069913,0.046582,0.021992,0.999996,0.999996,0.999996,0.999996,0.999995,1032.508157,17.195149,12.121621,25.390972,1024.812178,1033.146650,1041.537325,2.220749,6.214470,5.045673,0.004896,0.023827,0.022606,0.083165,0.432260,2.533760,0.114619,-0.592000,-55.824000,-1030.912000,9.109201,9.684680,17.198147,-0.045248,-0.117629,0.028053,4.775776,4.820572,5.866857,4.938766,5.503634,5.034010,1.224514,1.730564,1.093057,1.796074,5.045700,0.004994,0.023702,0.022539,0.083756,0.999849,0.999835,0.999836,0.999832,0.999819,0,0,0,0,0,0,0,0,0,4.000000,0.064895,0.070473,108.230255,108.239944,0,0,65.000000,10.000000,10.102999,2.312832,0.000029,0.000032,-0.000067,-0.000073,0.000111,0.000120,-4.219657,-0.012806,-1.298291,0.094373,-1.220977,-0.851300,-1.656516,-0.898563,-0.503573,-0.518072,-0.907876,-0.681724,-0.683515,2.276349,1.271966,1.177478,0.670053,0.389200,0.535904,0.468701,0.358315,0.401412,0.408432,0.277176,0.416881,0.263832,-2.605413,2.605549,0.000000,1.000000,0.000000,0.000000,0.000000,0.000000,0.000000,1.000000,0.000000,0.000000,0.000000,0.000000,1.000000,0.000000,0.000000,1.000000,0.000000,0.000000,0.000000,0.000000,0.000000,1.000000,0.000000,1.000000,0.000000,0.000000,0,0,0,0.000000,0,0.460000,0.381436,0,0.000000,0.000000,0.000000,1.000000,1.000000,0.000000,0.000000,0.000000],
        #     [0.997045,0.001975,-0.000462,0.003132,0.995973,0.997032,0.998125,1.991430,6.684610,5.043316,0.000026,0.000082,0.000129,0.001669,0.429596,0.578592,0.084244,0.005690,-0.002197,-0.997009,0.004215,0.004142,0.001986,-0.211637,-0.059390,0.278600,0.003118,0.002949,0.006081,0.010189,0.001646,0.002503,0.003770,0.928280,6.430644,4.864363,4.125379,4.076052,3.780755,5.483266,3.316073,6.539898,0.187497,0.000006,0.000322,-0.000338,0.002136,0.002629,0.002594,-0.685535,0.044408,-0.081718,610.623029,0.740438,0.167805,0.953468,610.103647,610.611076,611.159730,2.639377,6.684611,5.043487,0.000019,0.000107,0.000114,0.000547,0.429620,0.977837,0.127525,81.329091,82.662215,-599.509653,0.781223,0.770648,0.735384,0.053767,-0.019708,-0.007577,0.999997,0.999997,0.999997,0.999997,0.999997,1039.089605,98.496505,199.700670,311.593669,1016.629726,1032.310031,1045.829814,0.768697,6.210893,5.037175,0.043979,0.509501,0.307600,0.882675,0.457764,3.998994,0.033847,-61.008000,-110.736000,-1007.904000,193.001078,128.495301,61.590574,0.173279,-0.397117,-0.379175,6.262308,3.755059,5.034176,2.649263,3.447915,6.056113,4.769629,3.414010,1.711378,1.721381,5.052518,0.070514,0.481607,0.328149,1.051803,0.986927,0.984824,0.976698,0.956294,0.930033,0,0,0,0,0,0,0,0,0,9.000000,0.073299,0.052635,108.035385,108.075562,0,0,65.000000,10.000000,9.234028,2.222895,0.000027,0.000018,0.000058,0.000039,0,0,-11.544193,0.668531,-1.591211,-0.341888,-2.119975,-1.270080,-1.340364,-1.027513,-0.654320,-0.742344,-0.775554,-0.466268,-0.602530,3.710109,1.725766,1.368012,1.053356,0.868821,0.798928,0.670822,0.556145,0.653717,0.485538,0.522987,0.411762,0.440114,-0.742103,0.742129,1.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,1.000000,0.000000,1.000000,0.000000,0.000000,0.000000,0.000000,0.000000,1.000000,0.000000,0.000000,0.000000,0.000000,0.000000,1.000000,0.000000,1.000000,0.000000,0.000000,0,0,0,0.000000,0,0.450000,0.381436,0,0.000000,0.000000,0.000000,1.000000,1.000000,0.000000,0.000000,0.000000],
        #     [0.997087,0.005154,0.013011,0.022319,0.995655,0.996574,0.997640,0.494445,6.684599,5.042267,0.000294,0.000532,0.000520,0.003816,0.429383,3.383851,0.125610,0.010079,0.000903,-0.996617,0.020065,0.021346,0.001964,-0.195204,0.103414,-0.056961,0.031985,0.214124,0.419879,0.596497,0.001093,0.001466,0.002103,0.178362,3.222105,5.762418,5.648854,5.579577,3.135108,3.887787,3.992543,0.000000,0.000000,-0.000149,0.000289,0.029112,0.002205,0.002199,0.214511,-0.055620,-0.771099,0.062350,577.637002,3.110062,3.564472,4.299506,575.807687,576.406401,577.279453,2.141208,6.684597,5.039828,0.000157,0.000160,0.000112,0.000656,0.428673,0.000000,0.000000,131.177174,102.365420,-553.100562,7.875739,1.720014,1.682343,-0.897919,-0.877308,0.789081,0.999993,0.999980,0.999914,0.999844,0.999608,1037.558420,117.241957,124.889504,249.433653,1009.142210,1028.614600,1056.280242,1.475804,6.208276,5.048556,0.982608,1.841560,0.778827,1.390950,0.549035,2.810180,0.163066,94.768000,489.440000,-673.344000,501.777594,185.892804,319.392601,-0.387707,0.552694,0.240397,6.720625,3.553200,3.943426,2.406947,2.515597,5.454429,2.645239,2.597283,1.585403,1.767083,5.430595,2.440682,2.473348,2.004928,3.226609,0.948053,0.890258,0.755524,0.578447,0.586237,0,0,0,0,0,0,0,0,0,4.000000,0.102778,0.048655,105.762886,105.837547,0,0,65.000000,10.000000,12.905336,2.557641,0.000042,0.000022,0.000005,-0.000014,0.000021,0.000011,-19.492623,-1.024413,-1.700307,-0.415519,-1.509853,-0.636124,-1.070514,-0.757766,-0.949900,-0.927956,-0.744639,-0.456450,-0.755264,3.359413,1.168542,0.711076,0.499792,0.401068,0.305703,0.293758,0.237839,0.234492,0.239852,0.225973,0.214937,0.206188,-0.462680,0.462702,1.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,1.000000,0.000000,1.000000,0.000000,0.000000,0.000000,0.000000,0.000000,1.000000,0.000000,0.000000,0.000000,0.000000,0.000000,1.000000,0.000000,1.000000,0.000000,0.000000,0,0,0,0.000000,0,0.410000,0.378710,0,0.000000,0.000000,0.000000,1.000000,1.000000,0.000000,0.000000,0.000000],
        #     [0.997131,0.001334,-0.000367,0.001983,0.996323,0.997101,0.997922,2.261530,6.684611,5.043351,0.000018,0.000080,0.000116,0.000738,0.429587,1.647753,0.098192,0.011567,-0.002069,-0.997059,0.001627,0.001511,0.001331,0.083897,-0.134888,-0.053345,0.001738,0.000918,0.001028,0.001457,0.001092,0.001579,0.002185,2.244278,6.557294,4.895232,1.420970,2.941725,2.758110,4.656595,1.564203,0.099844,0.108586,-0.000187,0.000106,0.000342,0.001260,0.001220,0.000791,-0.537805,0.022881,-0.053708,573.340643,0.740009,-0.209032,0.968415,572.848398,573.362165,573.843233,2.606163,6.684611,5.043454,0.000009,0.000088,0.000119,0.000617,0.429612,1.422034,0.121263,129.035246,103.151869,-549.024537,0.759147,0.746484,0.749588,0.035744,-0.011492,0.099961,0.999997,0.999996,0.999997,0.999997,0.999996,1021.434746,105.707616,231.723470,351.793560,998.494867,1011.217078,1023.366987,0.595694,6.210506,5.032047,0.034487,0.082723,0.035643,0.175043,0.431715,0.707166,0.049522,-91.904000,610.896000,-788.512000,147.382899,153.448875,76.441624,0.097033,0.369160,0.411951,4.821820,1.641918,2.961337,2.004965,2.305159,5.126707,0.154067,0.174775,0.092040,0.256575,5.030751,0.074757,0.163052,0.077299,0.341831,0.984926,0.980037,0.977624,0.973077,0.937872,0,0,0,0,0,0,0,0,0,7.000000,0.043379,0.013491,105.442497,105.458130,0,0,65.000000,10.000000,5.068925,1.623129,0.000015,0.000005,-0.000044,-0.000013,0.000006,0.000005,-2.107704,0.301845,-0.972291,-0.098412,-1.213025,-0.851269,-1.131236,-0.499595,-0.932035,-0.872719,-0.747520,-0.365553,-0.747899,0.914571,0.768356,0.486962,0.431488,0.383967,0.318017,0.234512,0.225002,0.237044,0.235091,0.224515,0.198758,0.213425,-3.932438,3.932949,0.000000,0.000000,1.000000,0.000000,0.000000,0.000000,0.000000,1.000000,0.000000,1.000000,0.000000,0.000000,0.000000,0.000000,0.000000,1.000000,0.000000,0.000000,0.000000,0.000000,0.000000,1.000000,0.000000,1.000000,0.000000,0.000000,0,0,0,0.000000,0,0.390000,0.417149,0,0.000000,0.000000,0.000000,1.000000,1.000000,0.000000,0.000000,0.000000]
        # ]

        # values_matrix = np.loadtxt(open("D:\\nicho\Documents\RoutineChangeDetector\\app\ExtraSensory.per_uuid_features_labels\9DC38D04-E82E-4F29-AB52-B476535226F2.features_labels.csv", "rb"), delimiter=",", skiprows=1)
        # values_matrix = values_matrix[:1440,1:-52]

        standardized_values_matrix = standardize_features(values_matrix)
        result = predict(standardized_values_matrix, os.environ["META_DIR"], \
            os.environ["CHKPNT_DIR"], False)
        print(result[0])
        labels = ["lying down","sitting","walking","running","bicycling","sleeping","driving (driver)","driving (pass)","exercise","shopping", "strolling", \
            "stairs (up)","stairs (down)","standing","lab work","in class","in meeting","cooking","drinking alcohol","shower","cleaning","laundry","washing dishes",\
                "watching TV","surfing Internet","singing","talking","computer work","eating","toilet","grooming","dressing","with coworker", "with friends",\
                    "main workplace","indoors","outdoors","in car","on bus","home","restaurant","atParty","atBar",'beach','atGym',"elevator","atSchool"]
        response = {
            'labels': labels, 
            'classification': result
        }
        return Response( response , status=status.HTTP_200_OK)
